<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام ERP المحاسبي (شجرة حسابات وقيود)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .currency { font-family: 'Courier New', Courier, monospace; font-weight: bold; }
        .section-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .section-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        th { white-space: nowrap; font-size: 0.85rem; }
        td { font-size: 0.9rem; }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* طباعة */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { 
                position: absolute; left: 0; top: 0; width: 100%; min-height: 100%;
                background: white; padding: 20px; 
                direction: rtl; color: black;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden bg-gray-50">

    <!-- منطقة الطباعة (ديناميكية) -->
    <div id="print-area" class="hidden"></div>

    <!-- Overlay للموبايل -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden transition-opacity opacity-0"></div>

    <!-- القائمة الجانبية -->
    <aside id="sidebar" class="fixed inset-y-0 right-0 z-40 w-72 bg-slate-900 text-white flex flex-col shadow-2xl transform translate-x-full md:translate-x-0 md:static md:w-64 sidebar-transition no-print">
        <div class="p-6 border-b border-slate-700 flex items-center justify-between md:justify-center">
            <div class="text-center w-full">
                <h1 class="text-2xl font-bold text-blue-400">ERP المحاسبي</h1>
                <span class="text-xs text-gray-400 block mt-1">شجرة حسابات + قيود V6.1</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <nav class="flex-1 p-3 space-y-1 overflow-y-auto no-scrollbar text-sm">
            <button onclick="showSection('dashboard')" class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center bg-slate-800 text-blue-300" data-target="dashboard">
                <i class="fas fa-chart-line w-6 text-center ml-2"></i> لوحة القيادة
            </button>
            <button onclick="showSection('accounts_tree')" class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center" data-target="accounts_tree">
                <i class="fas fa-sitemap w-6 text-center ml-2"></i> شجرة الحسابات
            </button>
            <button onclick="showSection('journal')" class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center" data-target="journal">
                <i class="fas fa-book w-6 text-center ml-2"></i> القيود اليومية
            </button>
            <div class="border-t border-slate-700 my-2"></div>
            <button onclick="showSection('sales')" class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center" data-target="sales">
                <i class="fas fa-cash-register w-6 text-center ml-2"></i> المبيعات (POS)
            </button>
            <button onclick="showSection('purchases')" class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center" data-target="purchases">
                <i class="fas fa-truck-loading w-6 text-center ml-2"></i> المشتريات
            </button>
            <button onclick="showSection('expenses')" class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center" data-target="expenses">
                <i class="fas fa-file-invoice-dollar w-6 text-center ml-2"></i> المصروفات
            </button>
            <button onclick="showSection('inventory')" class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center" data-target="inventory">
                <i class="fas fa-cubes w-6 text-center ml-2"></i> المخزون
            </button>
            <div class="border-t border-slate-700 my-2"></div>
            <button onclick="showSection('reports')" class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center" data-target="reports">
                <i class="fas fa-file-contract w-6 text-center ml-2"></i> التقارير الختامية
            </button>
        </nav>
    </aside>

    <!-- المحتوى -->
    <main class="flex-1 flex flex-col w-full overflow-hidden no-print">
        <header class="bg-white shadow-sm p-3 md:p-4 flex justify-between items-center z-20 border-b sticky top-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-600 p-1"><i class="fas fa-bars text-xl"></i></button>
                <h2 id="page-title" class="text-lg font-bold text-gray-800">لوحة القيادة</h2>
            </div>
            <div class="flex items-center gap-2">
                <div class="text-xs font-bold text-gray-500 hidden md:block">السنة المالية: 2025</div>
                <button onclick="resetData()" class="text-red-400 bg-red-50 p-2 rounded-full hover:bg-red-100" title="تصفير النظام"><i class="fas fa-trash-alt"></i></button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50">
            
            <!-- 1. Dashboard -->
            <section id="dashboard" class="section-content active">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-green-500">
                        <span class="text-gray-500 text-xs">النقدية (خزينة وبنوك)</span>
                        <h3 class="text-xl font-bold mt-1 currency text-green-700" id="dash-cash">0.00</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-blue-500">
                        <span class="text-gray-500 text-xs">إيرادات المبيعات</span>
                        <h3 class="text-xl font-bold mt-1 currency" id="dash-sales">0.00</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-red-500">
                        <span class="text-gray-500 text-xs">المصروفات</span>
                        <h3 class="text-xl font-bold mt-1 currency" id="dash-expenses">0.00</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-purple-500">
                        <span class="text-gray-500 text-xs">صافي الربح</span>
                        <h3 class="text-xl font-bold mt-1 currency" id="dash-net-profit">0.00</h3>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">آخر القيود اليومية</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-100"><tr><th class="p-2">#</th><th class="p-2">التاريخ</th><th class="p-2">البيان</th><th class="p-2">المبلغ</th></tr></thead>
                            <tbody id="dash-journal-list"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 2. Chart of Accounts (Tree) -->
            <section id="accounts_tree" class="section-content">
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-800 text-lg">شجرة الحسابات (الدليل المحاسبي)</h3>
                        <button onclick="addAccountPrompt()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">+ حساب جديد</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse">
                            <thead class="bg-slate-800 text-white">
                                <tr>
                                    <th class="p-2 text-right w-24">كود</th>
                                    <th class="p-2 text-right">اسم الحساب</th>
                                    <th class="p-2 text-right w-32">النوع</th>
                                    <th class="p-2 text-right w-32">الرصيد</th>
                                </tr>
                            </thead>
                            <tbody id="coa-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 3. Journal Entries -->
            <section id="journal" class="section-content">
                <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                    <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">إضافة قيد يومية يدوي</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                        <input type="text" id="manual-desc" placeholder="شرح القيد (البيان)" class="p-2 border rounded w-full">
                        <input type="date" id="manual-date" class="p-2 border rounded w-full">
                    </div>
                    <div class="bg-gray-50 p-3 rounded border border-gray-200 mb-3">
                        <div id="journal-lines" class="space-y-2">
                            <!-- JS will add lines here -->
                        </div>
                        <button onclick="addJournalLineRow()" class="mt-2 text-sm text-blue-600 hover:underline">+ إضافة طرف</button>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-sm font-bold">
                            إجمالي مدين: <span id="total-dr" class="text-green-600">0.00</span> | 
                            إجمالي دائن: <span id="total-cr" class="text-red-600">0.00</span>
                            <span id="unbalanced-msg" class="text-red-500 text-xs hidden ml-2">(غير متزن!)</span>
                        </div>
                        <button onclick="saveManualJournal()" class="bg-slate-700 text-white px-6 py-2 rounded">حفظ القيد</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-3">دفتر اليومية العامة</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right border border-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 border">التاريخ</th>
                                    <th class="p-2 border">رقم القيد</th>
                                    <th class="p-2 border">البيان</th>
                                    <th class="p-2 border">تفاصيل القيد (من حـ / إلى حـ)</th>
                                </tr>
                            </thead>
                            <tbody id="general-journal-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 4. Sales (POS) -->
            <section id="sales" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-3">فاتورة مبيعات جديدة</h3>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <select id="sale-customer" class="p-2 border rounded text-sm bg-gray-50"></select>
                            <select id="sale-account" class="p-2 border rounded text-sm bg-gray-50" title="حساب القبض">
                                <!-- سيتم ملؤه بحسابات النقدية والبنوك -->
                            </select>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <select id="sale-product" class="flex-1 p-2 border rounded text-sm"></select>
                            <input type="number" id="sale-qty" value="1" class="w-16 p-2 border rounded text-center">
                            <button onclick="addToCart()" class="bg-green-600 text-white px-4 rounded">+</button>
                        </div>
                        <table class="w-full text-sm mb-3 border">
                            <thead class="bg-gray-100"><tr><th>الصنف</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th><th>X</th></tr></thead>
                            <tbody id="cart-body" class="text-center"></tbody>
                        </table>
                        <div class="flex justify-between items-center bg-gray-800 text-white p-3 rounded">
                            <span>الإجمالي: <span id="cart-total">0.00</span></span>
                            <button onclick="postSale()" class="bg-emerald-500 px-4 py-1 rounded font-bold">حفظ وترحيل القيد</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">* سيتم إنشاء قيد: من حـ/النقدية إلى حـ/المبيعات ومن حـ/ت.المبيعات إلى حـ/المخزون</p>
                    </div>
                    <div class="lg:col-span-1 bg-white p-4 rounded-xl shadow-sm">
                        <h3 class="font-bold mb-2">تعريف عميل جديد</h3>
                        <div class="space-y-2">
                            <input type="text" id="new-cust-name" placeholder="اسم العميل" class="w-full p-2 border rounded text-sm">
                            <button onclick="addCustomer()" class="w-full bg-blue-600 text-white p-2 rounded text-sm">حفظ</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5. Expenses -->
            <section id="expenses" class="section-content">
                <div class="bg-white p-4 rounded-xl shadow-sm max-w-2xl mx-auto">
                    <h3 class="font-bold text-gray-800 mb-4 text-center">تسجيل مصروف</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-500">نوع المصروف (الحساب المدين)</label>
                            <select id="exp-account-dr" class="w-full p-2 border rounded bg-white">
                                <!-- حسابات المصروفات -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500">طريقة الدفع (الحساب الدائن)</label>
                            <select id="exp-account-cr" class="w-full p-2 border rounded bg-white">
                                <!-- نقدية وبنوك -->
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="exp-amount" placeholder="المبلغ" class="p-2 border rounded">
                            <input type="text" id="exp-desc" placeholder="البيان (مثال: فاتورة كهرباء يناير)" class="p-2 border rounded">
                        </div>
                        <button onclick="postExpense()" class="w-full bg-red-600 text-white p-2 rounded font-bold">تسجيل وترحيل</button>
                    </div>
                </div>
            </section>

            <!-- 6. Purchases & Inventory -->
            <section id="purchases" class="section-content">
                <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                    <h3 class="font-bold text-gray-800 mb-3">فاتورة مشتريات (زيادة مخزون)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 items-end">
                        <div class="md:col-span-1">
                            <label class="text-xs text-gray-500">المنتج</label>
                            <select id="purch-product" class="w-full p-2 border rounded text-sm"></select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">الكمية</label>
                            <input type="number" id="purch-qty" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">التكلفة الإجمالية</label>
                            <input type="number" id="purch-cost" class="w-full p-2 border rounded text-sm">
                        </div>
                        <button onclick="postPurchase()" class="bg-blue-600 text-white p-2 rounded text-sm h-10">شراء وترحيل</button>
                    </div>
                    <div class="mt-2">
                        <label class="text-xs text-gray-500">طريقة الدفع (الدائن)</label>
                        <select id="purch-account-cr" class="p-2 border rounded text-sm w-full md:w-1/3"></select>
                    </div>
                </div>
            </section>

            <section id="inventory" class="section-content">
                <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                    <h3 class="font-bold text-gray-800 mb-3">تعريف صنف جديد</h3>
                    <div class="flex gap-2">
                        <input type="text" id="new-prod-name" placeholder="اسم المنتج" class="flex-1 p-2 border rounded">
                        <input type="number" id="new-prod-price" placeholder="سعر البيع" class="w-24 p-2 border rounded">
                        <button onclick="addNewProduct()" class="bg-slate-700 text-white px-4 rounded">حفظ</button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-gray-100"><tr><th>المنتج</th><th>سعر البيع</th><th>متوسط التكلفة</th><th>الكمية</th></tr></thead>
                        <tbody id="inventory-list"></tbody>
                    </table>
                </div>
            </section>

            <!-- 7. Reports -->
            <section id="reports" class="section-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- ميزان المراجعة -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-center border-b pb-2 mb-2">ميزان المراجعة (Trial Balance)</h3>
                        <div class="overflow-x-auto max-h-96">
                            <table class="w-full text-xs text-right">
                                <thead class="bg-gray-100 font-bold"><tr><th>الحساب</th><th>مدين</th><th>دائن</th></tr></thead>
                                <tbody id="trial-balance-body"></tbody>
                                <tfoot class="bg-gray-200 font-bold"><tr><td>الإجمالي</td><td id="tb-total-dr">0</td><td id="tb-total-cr">0</td></tr></tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- قائمة الدخل -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-center border-b pb-2 mb-2">قائمة الدخل (Income Statement)</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between font-bold text-blue-700"><span>الإيرادات</span><span id="is-rev">0.00</span></div>
                            <div class="flex justify-between text-red-600"><span>(-) تكلفة البضاعة المباعة</span><span id="is-cogs">0.00</span></div>
                            <div class="flex justify-between bg-gray-100 font-bold p-1"><span>مجمل الربح</span><span id="is-gross">0.00</span></div>
                            <div class="flex justify-between text-red-600"><span>(-) المصروفات</span><span id="is-exp">0.00</span></div>
                            <div class="border-t-2 border-gray-800 pt-2 mt-2">
                                <div class="flex justify-between text-lg font-bold"><span>صافي الربح</span><span id="is-net">0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <script>
        // --- 1. هيكل البيانات الأساسي (Data Structure) ---
        let db = {
            // شجرة الحسابات الافتراضية (Standard Chart of Accounts)
            chartOfAccounts: [
                // 1. Assets (الأصول) - Type: asset
                { code: '1101', name: 'الخزينة الرئيسية', type: 'asset', balance: 0, parent: '11' },
                { code: '1102', name: 'البنك الأهلي', type: 'asset', balance: 0, parent: '11' },
                { code: '1103', name: 'العملاء (ذمم مدينة)', type: 'asset', balance: 0, parent: '11' },
                { code: '1104', name: 'المخزون', type: 'asset', balance: 0, parent: '11' },
                
                // 2. Liabilities (الخصوم) - Type: liability
                { code: '2101', name: 'الموردين (ذمم دائنة)', type: 'liability', balance: 0, parent: '21' },
                { code: '2102', name: 'ضريبة القيمة المضافة', type: 'liability', balance: 0, parent: '21' },
                
                // 3. Equity (حقوق الملكية) - Type: equity
                { code: '3101', name: 'رأس المال', type: 'equity', balance: 0, parent: '31' },
                { code: '3102', name: 'الأرباح المبقاة', type: 'equity', balance: 0, parent: '31' },

                // 4. Revenue (الإيرادات) - Type: revenue
                { code: '4101', name: 'إيرادات المبيعات', type: 'revenue', balance: 0, parent: '41' },
                { code: '4102', name: 'إيرادات خدمات', type: 'revenue', balance: 0, parent: '41' },

                // 5. Expenses (المصروفات) - Type: expense
                { code: '5101', name: 'تكلفة البضاعة المباعة (COGS)', type: 'expense', balance: 0, parent: '51' },
                { code: '5201', name: 'مصروفات إيجار', type: 'expense', balance: 0, parent: '52' },
                { code: '5202', name: 'رواتب وأجور', type: 'expense', balance: 0, parent: '52' },
                { code: '5203', name: 'كهرباء ومياه', type: 'expense', balance: 0, parent: '52' }
            ],
            
            // سجل القيود (Journal Ledger)
            // { id: 1, date: '...', desc: '...', lines: [{code: '1101', dr: 100, cr: 0}, ...] }
            journal: [],
            
            // المنتجات
            products: [
                {id: 1, name: 'منتج تجريبي', price: 100, cost: 80, stock: 10}
            ],
            
            // العملاء (لربطهم بالحساب الفرعي)
            customers: [{id: 1, name: 'عميل نقدي'}]
        };

        // متغيرات مؤقتة
        let currentCart = [];

        // --- 2. التهيئة والحفظ ---
        function init() {
            const saved = localStorage.getItem('erp_accounting_v6');
            if(saved) {
                db = JSON.parse(saved);
                // Ensure legacy data migration if needed (skipped for simplicity)
            } else {
                // قيد افتتاحي تجريبي (رأس المال -> الخزينة)
                addJournalEntry('2025-01-01', 'قيد افتتاحي: رأس المال', [
                    {code: '1101', dr: 50000, cr: 0}, // خزينة
                    {code: '3101', dr: 0, cr: 50000}  // رأس مال
                ]);
            }
            // ملء القوائم المنسدلة
            populateSelects();
            renderAll();
            // Add initial row for manual journal
            addJournalLineRow();
            addJournalLineRow();
        }

        function save() {
            localStorage.setItem('erp_accounting_v6', JSON.stringify(db));
            renderAll();
        }

        function resetData() {
            if(confirm('تنبيه: سيتم حذف جميع القيود والحسابات!')) {
                localStorage.removeItem('erp_accounting_v6');
                location.reload();
            }
        }

        // --- 3. المحرك المحاسبي (Accounting Engine) ---
        
        // الوظيفة الأساسية: إضافة قيد وترحيله للحسابات
        function addJournalEntry(date, desc, lines) {
            // lines array format: {code: 'acc_code', dr: 0, cr: 0}
            
            // 1. Validate Balance
            const totalDr = lines.reduce((sum, l) => sum + (l.dr || 0), 0);
            const totalCr = lines.reduce((sum, l) => sum + (l.cr || 0), 0);
            
            if (Math.abs(totalDr - totalCr) > 0.01) {
                alert(`خطأ محاسبي: القيد غير متزن! مدين: ${totalDr} - دائن: ${totalCr}`);
                return false;
            }

            // 2. Add to Ledger
            const entryId = db.journal.length + 1;
            db.journal.push({
                id: entryId,
                date: date,
                desc: desc,
                lines: lines
            });

            // 3. Post to Accounts (Update Balances)
            lines.forEach(line => {
                const acc = db.chartOfAccounts.find(a => a.code === line.code);
                if(acc) {
                    // طبيعة الحسابات:
                    // مدين (Asset, Expense): يزيد بالمدين، ينقص بالدائن
                    // دائن (Liability, Equity, Revenue): يزيد بالدائن، ينقص بالمدين
                    
                    // سنقوم بتخزين "الرصيد الصافي" (Net Debit Balance) للأصول والمصروفات
                    // و "الرصيد الصافي" (Net Credit Balance) للخصوم والإيرادات وحقوق الملكية
                    // لتبسيط العرض لاحقاً
                    
                    if(acc.type === 'asset' || acc.type === 'expense') {
                        acc.balance += (line.dr - line.cr);
                    } else {
                        acc.balance += (line.cr - line.dr);
                    }
                }
            });

            save();
            return true;
        }

        // Helper to get Account Name
        function getAccName(code) {
            const acc = db.chartOfAccounts.find(a => a.code === code);
            return acc ? acc.name : code;
        }

        // --- 4. العمليات (المبيعات، المشتريات، المصروفات) ---

        function addToCart() {
            const prodId = document.getElementById('sale-product').value;
            const qty = parseInt(document.getElementById('sale-qty').value);
            const prod = db.products.find(p => p.id == prodId);
            
            if(!prod || prod.stock < qty) return alert('الرصيد غير كاف');
            
            currentCart.push({id: prod.id, name: prod.name, price: prod.price, cost: prod.cost, qty: qty, total: prod.price * qty});
            renderCart();
        }

        function renderCart() {
            const tbody = document.getElementById('cart-body');
            tbody.innerHTML = currentCart.map((i, idx) => `<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.price}</td><td>${i.total}</td><td class="text-red-500 cursor-pointer" onclick="currentCart.splice(${idx},1);renderCart()">X</td></tr>`).join('');
            document.getElementById('cart-total').innerText = currentCart.reduce((s, i) => s + i.total, 0).toFixed(2);
        }

        function postSale() {
            if(currentCart.length === 0) return alert('السلة فارغة');
            const debitAcc = document.getElementById('sale-account').value; // Cash or Bank or Receivable
            const totalSale = currentCart.reduce((s, i) => s + i.total, 0);
            const totalCost = currentCart.reduce((s, i) => s + (i.cost * i.qty), 0);
            
            const date = new Date().toISOString().split('T')[0];
            const customerName = document.getElementById('sale-customer').options[document.getElementById('sale-customer').selectedIndex].text;

            // 1. قيد المبيعات (من حـ/النقدية إلى حـ/الإيرادات)
            // * للتبسيط لن نحسب الضريبة هنا بشكل منفصل، يمكن إضافتها بسهولة بإضافة طرف ثالث
            const saleLines = [
                {code: debitAcc, dr: totalSale, cr: 0},
                {code: '4101', dr: 0, cr: totalSale} // Sales Revenue
            ];
            
            // 2. قيد التكلفة (من حـ/تكلفة البضاعة إلى حـ/المخزون) - Perpetual Inventory System
            const costLines = [
                {code: '5101', dr: totalCost, cr: 0}, // COGS
                {code: '1104', dr: 0, cr: totalCost}  // Inventory
            ];

            if(addJournalEntry(date, `مبيعات للعميل: ${customerName}`, [...saleLines, ...costLines])) {
                // Update Stock
                currentCart.forEach(item => {
                    const p = db.products.find(x => x.id == item.id);
                    if(p) p.stock -= item.qty;
                });
                
                alert('تم حفظ الفاتورة وترحيل القيود بنجاح');
                currentCart = [];
                renderCart();
            }
        }

        function postExpense() {
            const drCode = document.getElementById('exp-account-dr').value;
            const crCode = document.getElementById('exp-account-cr').value;
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const desc = document.getElementById('exp-desc').value;
            
            if(!amount || !desc) return alert('أكمل البيانات');

            const lines = [
                {code: drCode, dr: amount, cr: 0},
                {code: crCode, dr: 0, cr: amount}
            ];

            if(addJournalEntry(new Date().toISOString().split('T')[0], `مصروف: ${desc}`, lines)) {
                alert('تم ترحيل المصروف');
                document.getElementById('exp-amount').value = '';
                document.getElementById('exp-desc').value = '';
            }
        }

        function postPurchase() {
            const prodId = document.getElementById('purch-product').value;
            const qty = parseFloat(document.getElementById('purch-qty').value);
            const totalCost = parseFloat(document.getElementById('purch-cost').value);
            const crAccount = document.getElementById('purch-account-cr').value;
            
            const prod = db.products.find(p => p.id == prodId);
            
            // قيد المخزون (من حـ/المخزون إلى حـ/النقدية أو الموردين)
            const lines = [
                {code: '1104', dr: totalCost, cr: 0}, // Inventory
                {code: crAccount, dr: 0, cr: totalCost}
            ];

            if(addJournalEntry(new Date().toISOString().split('T')[0], `شراء مخزون: ${prod.name}`, lines)) {
                prod.stock += qty;
                // تحديث متوسط التكلفة (بسيط)
                prod.cost = totalCost / qty; // تحديث التكلفة لآخر سعر شراء (أو عمل معادلة المتوسط المرجح)
                alert('تم الشراء والترحيل');
            }
        }

        // --- 5. واجهة القيود اليدوية ---
        function addJournalLineRow() {
            const container = document.getElementById('journal-lines');
            const row = document.createElement('div');
            row.className = 'flex gap-2 mb-2 journal-row';
            
            // Account Select
            let opts = '<option value="">اختر الحساب...</option>';
            db.chartOfAccounts.forEach(acc => opts += `<option value="${acc.code}">${acc.code} - ${acc.name}</option>`);
            
            row.innerHTML = `
                <select class="flex-1 p-2 border rounded text-xs j-acc">${opts}</select>
                <input type="number" placeholder="مدين" class="w-20 p-2 border rounded text-xs j-dr" onchange="calcJournalTotals()">
                <input type="number" placeholder="دائن" class="w-20 p-2 border rounded text-xs j-cr" onchange="calcJournalTotals()">
                <button onclick="this.parentElement.remove();calcJournalTotals()" class="text-red-500 px-2">x</button>
            `;
            container.appendChild(row);
        }

        function calcJournalTotals() {
            let dr = 0, cr = 0;
            document.querySelectorAll('.j-dr').forEach(i => dr += parseFloat(i.value || 0));
            document.querySelectorAll('.j-cr').forEach(i => cr += parseFloat(i.value || 0));
            
            document.getElementById('total-dr').innerText = dr.toFixed(2);
            document.getElementById('total-cr').innerText = cr.toFixed(2);
            
            const msg = document.getElementById('unbalanced-msg');
            if(Math.abs(dr - cr) > 0.01) msg.classList.remove('hidden');
            else msg.classList.add('hidden');
        }

        function saveManualJournal() {
            const desc = document.getElementById('manual-desc').value;
            const date = document.getElementById('manual-date').value || new Date().toISOString().split('T')[0];
            const rows = document.querySelectorAll('.journal-row');
            
            let lines = [];
            rows.forEach(row => {
                const code = row.querySelector('.j-acc').value;
                const dr = parseFloat(row.querySelector('.j-dr').value || 0);
                const cr = parseFloat(row.querySelector('.j-cr').value || 0);
                if(code && (dr > 0 || cr > 0)) {
                    lines.push({code, dr, cr});
                }
            });

            if(lines.length < 2) return alert('يجب أن يحتوي القيد على طرفين على الأقل');
            
            if(addJournalEntry(date, desc, lines)) {
                alert('تم حفظ القيد');
                document.getElementById('manual-desc').value = '';
                document.getElementById('journal-lines').innerHTML = '';
                addJournalLineRow();
                addJournalLineRow();
                calcJournalTotals();
            }
        }

        // --- 6. Helper Functions & UI Rendering ---
        
        // This function was missing in the previous version causing ReferenceError
        function addAccountPrompt() {
            const code = prompt('أدخل كود الحساب (مثال: 1105):');
            if (!code) return;
            const name = prompt('أدخل اسم الحساب:');
            if (!name) return;
            const type = prompt('أدخل نوع الحساب (asset, liability, equity, revenue, expense):');
            if (!type || !['asset', 'liability', 'equity', 'revenue', 'expense'].includes(type)) {
                alert('نوع الحساب غير صحيح. استخدم: asset, liability, equity, revenue, expense');
                return;
            }
            
            db.chartOfAccounts.push({ code, name, type, balance: 0, parent: code.substring(0, 2) });
            save();
            populateSelects(); // Update dropdowns with new account
            alert('تم إضافة الحساب بنجاح');
        }

        function populateSelects() {
            // Helper to generate options
            const genOpts = (filterFn) => {
                return db.chartOfAccounts.filter(filterFn).map(a => `<option value="${a.code}">${a.name}</option>`).join('');
            };

            // Sale Account (Assets: Cash/Bank/Receivable)
            document.getElementById('sale-account').innerHTML = genOpts(a => ['1101', '1102', '1103'].includes(a.code));
            
            // Expense Debit (Type Expense)
            document.getElementById('exp-account-dr').innerHTML = genOpts(a => a.type === 'expense' && a.code !== '5101'); // Exclude COGS usually auto
            
            // Expense Credit (Cash/Bank)
            const payAccounts = genOpts(a => ['1101', '1102'].includes(a.code));
            document.getElementById('exp-account-cr').innerHTML = payAccounts;
            document.getElementById('purch-account-cr').innerHTML = payAccounts + genOpts(a => a.code === '2101'); // Add Suppliers

            // Products & Customers
            document.getElementById('sale-product').innerHTML = db.products.map(p => `<option value="${p.id}">${p.name} ($${p.price})</option>`).join('');
            document.getElementById('purch-product').innerHTML = db.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            document.getElementById('sale-customer').innerHTML = db.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function addCustomer() {
            const name = document.getElementById('new-cust-name').value;
            if(name) {
                db.customers.push({id: Date.now(), name});
                populateSelects();
                alert('تمت الإضافة');
            }
        }

        function addNewProduct() {
            const name = document.getElementById('new-prod-name').value;
            const price = parseFloat(document.getElementById('new-prod-price').value);
            if(name && price) {
                db.products.push({id: Date.now(), name, price, cost: 0, stock: 0});
                populateSelects();
                alert('تمت الإضافة');
            }
        }

        function renderAll() {
            // 1. Dashboard
            const getBal = (code) => { const a = db.chartOfAccounts.find(x => x.code === code); return a ? a.balance : 0; };
            const cashTotal = getBal('1101') + getBal('1102');
            
            document.getElementById('dash-cash').innerText = cashTotal.toFixed(2);
            document.getElementById('dash-sales').innerText = getBal('4101').toFixed(2);
            
            // Calc Total Expenses
            const totalExp = db.chartOfAccounts.filter(a => a.type === 'expense').reduce((s, a) => s + a.balance, 0);
            document.getElementById('dash-expenses').innerText = totalExp.toFixed(2);
            
            // Net Profit (Rev - Exp)
            const totalRev = db.chartOfAccounts.filter(a => a.type === 'revenue').reduce((s, a) => s + a.balance, 0);
            document.getElementById('dash-net-profit').innerText = (totalRev - totalExp).toFixed(2);

            // 2. Chart of Accounts Table
            const coaBody = document.getElementById('coa-body');
            coaBody.innerHTML = db.chartOfAccounts.map(acc => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-2 font-mono">${acc.code}</td>
                    <td class="p-2 font-bold text-gray-700">${acc.name}</td>
                    <td class="p-2 text-xs">
                        <span class="px-2 py-1 rounded bg-gray-200 text-gray-600">
                            ${{'asset':'أصل','liability':'التزام','equity':'ملكية','revenue':'إيراد','expense':'مصروف'}[acc.type]}
                        </span>
                    </td>
                    <td class="p-2 font-bold ${acc.balance < 0 ? 'text-red-500' : 'text-green-600'}">${acc.balance.toFixed(2)}</td>
                </tr>
            `).join('');

            // 3. Journal Table
            const renderJournal = (limit) => {
                const entries = limit ? db.journal.slice().reverse().slice(0, limit) : db.journal.slice().reverse();
                return entries.map(e => `
                    <tr class="bg-gray-50 border-b">
                        <td class="p-2 font-bold" colspan="4">${e.id}# - ${e.desc} <span class="text-xs text-gray-400">(${e.date})</span></td>
                    </tr>
                    ${e.lines.map(l => `
                        <tr class="text-xs border-b">
                            <td></td>
                            <td></td>
                            <td class="text-gray-600">${getAccName(l.code)}</td>
                            <td>
                                <span class="text-green-600 ml-2">${l.dr > 0 ? l.dr.toFixed(2) + ' (مدين)' : ''}</span>
                                <span class="text-red-600">${l.cr > 0 ? l.cr.toFixed(2) + ' (دائن)' : ''}</span>
                            </td>
                        </tr>
                    `).join('')}
                `).join('');
            };
            document.getElementById('dash-journal-list').innerHTML = renderJournal(5);
            document.getElementById('general-journal-body').innerHTML = renderJournal(50);

            // 4. Inventory List
            document.getElementById('inventory-list').innerHTML = db.products.map(p => `
                <tr class="border-b">
                    <td class="p-2">${p.name}</td>
                    <td class="p-2">${p.price}</td>
                    <td class="p-2">${p.cost.toFixed(2)}</td>
                    <td class="p-2 font-bold">${p.stock}</td>
                </tr>
            `).join('');

            // 5. Reports
            // Trial Balance
            let tbDr = 0, tbCr = 0;
            document.getElementById('trial-balance-body').innerHTML = db.chartOfAccounts.map(acc => {
                if(acc.balance === 0) return '';
                // تحديد طبيعة العرض في ميزان المراجعة (عرض مبسط)
                // الأصول والمصروفات طبيعتها مدينة
                let dr = 0, cr = 0;
                if(acc.type === 'asset' || acc.type === 'expense') {
                    if(acc.balance > 0) dr = acc.balance; else cr = -acc.balance;
                } else {
                    if(acc.balance > 0) cr = acc.balance; else dr = -acc.balance;
                }
                tbDr += dr; tbCr += cr;
                return `<tr><td class="border p-1">${acc.name}</td><td class="border p-1">${dr?dr.toFixed(2):'-'}</td><td class="border p-1">${cr?cr.toFixed(2):'-'}</td></tr>`;
            }).join('');
            document.getElementById('tb-total-dr').innerText = tbDr.toFixed(2);
            document.getElementById('tb-total-cr').innerText = tbCr.toFixed(2);

            // Income Statement
            document.getElementById('is-rev').innerText = totalRev.toFixed(2);
            const cogs = getBal('5101');
            document.getElementById('is-cogs').innerText = cogs.toFixed(2);
            document.getElementById('is-gross').innerText = (totalRev - cogs).toFixed(2);
            document.getElementById('is-exp').innerText = (totalExp - cogs).toFixed(2); // المصروفات التشغيلية فقط
            document.getElementById('is-net').innerText = (totalRev - totalExp).toFixed(2);
        }

        function showSection(id) {
            document.querySelectorAll('.section-content').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(window.innerWidth < 768) toggleSidebar();
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            if(sb.classList.contains('translate-x-full')) {
                sb.classList.remove('translate-x-full'); ov.classList.remove('hidden'); setTimeout(()=>ov.classList.remove('opacity-0'),10);
            } else {
                sb.classList.add('translate-x-full'); ov.classList.add('opacity-0'); setTimeout(()=>ov.classList.add('hidden'),300);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
